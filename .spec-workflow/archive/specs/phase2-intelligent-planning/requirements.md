# Requirements Document

## Introduction

Phase 2 聚焦于构建「任务规划智能体 + 智能调度」能力，让 CogniCal 在完成智能任务解析后，进一步承担计划提交、时间编排与冲突消解的责任。本阶段目标是让用户可以一键请求 AI 生成可执行的任务推进策略和时间安排，同时保持透明、可干预、离线优先的体验。

## Alignment with Product Vision

- **语义理解与知识结构化**：在既有任务模型基础上，通过任务规划智能体输出结构化计划、依赖链与执行顺序。
- **智能调度与资源编排**：提供多方案时间块安排、冲突检测与解决建议，落实「主动生成稳健可行的执行计划」。
- **洞察反馈与习惯养成**：利用行为学习结果驱动个性化调度参数，持续跟踪方案执行反馈，为后续洞察模块奠定数据基础。

## Requirements

### Requirement 1 — 任务规划智能体生成多方案推进策略

**User Story:** 作为需要推进多个项目的知识工作者，我希望 AI 能基于当前任务列表生成 2-3 套不同的推进策略，以便我快速评估并选择合适的执行路径。

#### Acceptance Criteria

1. WHEN 用户在任务列表中勾选 ≥1 个任务并点击「生成计划」 THEN 系统 SHALL 返回至少 2 套包含执行顺序、依赖说明、预计持续时间的方案，并附带 CoT 推理摘要。
2. IF 某方案包含并行子任务 THEN 系统 SHALL 明确标记可并行项与所需前置条件。
3. WHEN 用户拒绝全部方案 THEN 系统 SHALL 允许用户输入约束（如每日可用时段、优先级偏好）并重新生成新方案。

### Requirement 2 — 智能时间块调度与日历同步

**User Story:** 作为需要精确时间规划的用户，我希望系统能基于选定的推进方案自动生成时间块并写入日历，让我直接看到可执行的日程表。

#### Acceptance Criteria

1. WHEN 用户确认某套推进方案 THEN 系统 SHALL 在日/周视图中绘制对应时间块，时间分配应尊重任务截止时间、估算工时与用户可用时段。
2. IF 新生成的时间块与已存在事件冲突 THEN 系统 SHALL 暴露冲突详情并提供至少 2 种调整建议（推迟、拆分、替换时段）。

### Requirement 3 — 冲突检测与解决方案解释

**User Story:** 作为希望保持掌控感的用户，我希望系统能提前告知调度中的冲突与风险，并解释每个解决方案的利弊，帮助我快速决策。

#### Acceptance Criteria

1. WHEN 生成时间块时发现重叠或超负荷（单日排程超出用户设定的最大工时） THEN 系统 SHALL 将冲突条目展示在独立面板中，并标记风险等级。
2. IF 系统给出冲突解决方案 THEN 系统 SHALL 为每个方案提供 CoT 推理摘要，说明调整理由、对截止时间的影响、以及潜在权衡。
3. WHEN 用户接受冲突解决方案 THEN 系统 SHALL 更新对应时间块，并在后台记录该决策用于后续行为学习。

### Requirement 4 — 行为习惯学习与个性化调度参数

**User Story:** 作为希望保持长期节奏的人，我希望系统能根据我的执行历史自动调整调度策略，例如避开低效时段或自动预留缓冲时间。

#### Acceptance Criteria

1. WHEN 用户完成或推迟任务时 THEN 系统 SHALL 记录实际耗时、完成状态与时间段，用于训练调度偏好。
2. IF 系统检测到特定时段完成率 < 40% 持续两周 THEN 系统 SHALL 在后续方案中降低该时段推荐权重，并在方案解释中提示原因。
3. WHEN 用户在设置中启用「个性化调度」 THEN 系统 SHALL 允许查看与调整学习到的偏好（例如高效时段、每日最大专注时长）。

## Non-Functional Requirements

### Code Architecture and Modularity

- 规划智能体、调度优化、冲突管理需拆分为独立服务模块，并保持 API 清晰（Rust 服务层 + Tauri 命令接口 + 前端 hooks/组件）。
- 所有 CoT/MCTS 推理逻辑需集中管理，避免散落在 UI 层，保持可测试性。
- 日历写入与冲突面板应复用现有状态管理（Zustand + React Query），禁止新增全局可变单例。

### Performance

- 任务规划与调度生成在本地执行时应在 4 秒内返回首套方案；若依赖外部 API，则需提供加载指示并在 10 秒超时后给出降级方案。
- UI 更新（时间块绘制、冲突面板刷新）应在主线程 100ms 内完成，避免阻塞交互。

### Security

- 所有行为学习数据仅存储于本地 SQLite，并遵循现有加密/备份策略。
- 与 DeepSeek API 通信继续使用安全通道，并确保不上传完整用户任务描述以外的个人敏感信息。

### Reliability

- 若调度写入失败（数据库或日历 API 异常），系统必须回滚已生成的时间块并提示用户。
- 推理缓存命中率需达到 60% 以上，避免重复调用造成体验波动。

### Usability

- 全部 AI 生成内容需附带可展开的推理说明，默认折叠，保持界面整洁。
- 在冲突面板和个性化设置中提供清晰的「原因说明」，让用户理解系统决策并能手动调整。
