{
  "id": "snapshot_1760444442049_1owvpdrpx",
  "approvalId": "approval_1760444442000_stqhbeq05",
  "approvalTitle": "DeepSeek API 集成 - Design 文档审批",
  "version": 1,
  "timestamp": "2025-10-14T12:20:42.049Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: DeepSeek API Integration\r\n\r\n## Overview\r\n\r\nImplement real DeepSeek API integration across CogniCal to replace placeholder local-only logic. Provide a robust, privacy-first, and resilient AI layer that powers: task parsing, recommendations, and scheduling. Ensure seamless online/offline switching with a shared provider interface and clear UI state.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- Use Tauri 2 + Rust for backend services (HTTP via reqwest)\r\n- React + TypeScript frontend with Zustand and Query\r\n- Separate service layer (Rust) from UI; expose via Tauri Commands\r\n- Follow module isolation: `ai_service.rs`, `cot_engine.rs`, `prompt_templates.rs`, `ai_cache.rs`\r\n- Testing with Vitest (frontend), cargo test (Rust), Playwright for E2E\r\n\r\n### Project Structure (structure.md)\r\n- Place Rust services under `src-tauri/src/services/`\r\n- Tauri commands defined in `src-tauri/src/commands/`\r\n- Frontend hooks in `src/hooks/`, stores under `src/stores/`\r\n- Types under `src/types/`\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- `src-tauri/src/services/ai_service.rs`: Base for wiring DeepSeek HTTP calls\r\n- `src-tauri/src/services/cot_engine.rs`: Offline fallback engine\r\n- `src-tauri/src/services/planning_service.rs`: Scheduling integration points\r\n- `src/stores/settingsStore.ts`: Place to store AI settings (API key, mode)\r\n- `src/hooks/useTaskForm.ts`: Entry point for AI task parsing UX\r\n\r\n### Integration Points\r\n- Tauri Command: `ai_parse_task`, `ai_generate_recommendations`, `ai_plan_schedule`\r\n- Database: store encrypted API key and AI telemetry in SQLite (`ai_settings`, `ai_cache`)\r\n- UI: Settings page to configure key; onboarding to prompt configuration\r\n\r\n## Architecture\r\n\r\n### High-Level\r\n\r\n- Provider Interface (Trait): `AIProvider` with `parse_task`, `generate_recommendations`, `plan_schedule`\r\n- Implementations:\r\n  - Online: `DeepSeekProvider` (HTTP via reqwest)\r\n  - Offline: `LocalCotProvider` (existing `cot_engine`)\r\n- Selector/Facade: `AiService` decides which provider to call based on connectivity and settings\r\n- Caching Layer: `AiCache` computes cache keys and stores results\r\n- Prompt Templates: YAML-based templates loaded at startup; hot-reloadable\r\n\r\n### Modular Design Principles\r\n- Single file responsibility per module\r\n- Clear boundary: Provider interface vs concrete implementations\r\n- Error types are structured enums; mapped to UI-friendly messages\r\n- Backoff + retry policies centralized\r\n\r\n```mermaid\r\nflowchart TD\r\n  UI[React UI] --> IPC[Tauri Commands]\r\n  IPC --> SVC[AiService]\r\n  SVC -->|online| DSP[DeepSeekProvider]\r\n  SVC -->|offline| LCP[LocalCotProvider]\r\n  SVC --> CACHE[AiCache]\r\n  DSP --> HTTP[DeepSeek API]\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### Trait: AIProvider (Rust)\r\n- Purpose: Unified interface for AI operations\r\n- Interfaces:\r\n  - `async fn parse_task(input: &str, ctx: Context) -> AppResult<ParsedTask>`\r\n  - `async fn generate_recommendations(task: &Task, ctx: Context) -> AppResult<Recommendations>`\r\n  - `async fn plan_schedule(tasks: &[Task], ctx: Context) -> AppResult<Plan>`\r\n- Dependencies: common types (`Task`, `Plan`, etc.)\r\n\r\n### Struct: DeepSeekProvider\r\n- Purpose: Online provider calling DeepSeek API\r\n- Interfaces:\r\n  - Internal `invoke_chat(payload) -> AppResult<ChatResponse>`\r\n  - Public methods implementing AIProvider\r\n- Dependencies: `reqwest`, `serde`, `tokio`, `prompt_templates`\r\n- Reuses: HTTP client configuration (timeout 10s), retry policy\r\n\r\n### Struct: LocalCotProvider\r\n- Purpose: Offline provider using `cot_engine`\r\n- Reuses: existing logic; adapt to AIProvider trait\r\n\r\n### Facade: AiService\r\n- Purpose: Route calls to providers, manage cache, metrics, and mode switching\r\n- Interfaces (exposed via Tauri Commands):\r\n  - `ai_parse_task(input: String) -> ParsedTaskDTO`\r\n  - `ai_generate_recommendations(task_id: i64) -> RecommendationsDTO`\r\n  - `ai_plan_schedule() -> PlanDTO`\r\n- Dependencies: providers, cache, keyring, db\r\n\r\n### Frontend Hook: useAI\r\n- Purpose: Single entry for UI to call AI features\r\n- Interfaces:\r\n  - `parseTask(input: string): Promise<ParsedTask>`\r\n  - `generateRecommendations(taskId: string): Promise<Recommendations>`\r\n  - `planSchedule(): Promise<Plan>`\r\n  - `mode: 'online' | 'offline'`\r\n  - `stats: { callsToday, successRate, avgLatency }`\r\n- Dependencies: Tauri invoke, Zustand store\r\n\r\n## Data Models\r\n\r\n### Rust Types\r\n```\r\npub struct ParsedTask {\r\n  pub title: String,\r\n  pub description: Option<String>,\r\n  pub priority: Option<String>,\r\n  pub due_at: Option<String>,\r\n  pub planned_start_at: Option<String>,\r\n  pub estimated_hours: Option<f32>,\r\n  pub tags: Vec<String>,\r\n  pub cot_steps: Vec<String>,\r\n  pub confidence: f32,\r\n}\r\n\r\npub struct Recommendations {\r\n  pub priority: String,\r\n  pub start_at: Option<String>,\r\n  pub effort_hours: Option<f32>,\r\n  pub reasons: Vec<String>,\r\n  pub conflicts: Vec<String>,\r\n  pub confidence: f32,\r\n}\r\n\r\npub struct Plan {\r\n  pub items: Vec<PlanItem>,\r\n  pub conflicts: Vec<String>,\r\n}\r\n\r\npub struct PlanItem {\r\n  pub task_id: i64,\r\n  pub start: String,\r\n  pub end: String,\r\n  pub notes: Option<String>,\r\n}\r\n```\r\n\r\n### SQLite Schema Changes\r\n```\r\nCREATE TABLE IF NOT EXISTS ai_settings (\r\n  id INTEGER PRIMARY KEY CHECK (id = 1),\r\n  encrypted_api_key BLOB NOT NULL,\r\n  created_at TEXT NOT NULL,\r\n  updated_at TEXT NOT NULL\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS ai_cache (\r\n  cache_key TEXT PRIMARY KEY,\r\n  result_json TEXT NOT NULL,\r\n  created_at TEXT NOT NULL,\r\n  expires_at TEXT NOT NULL\r\n);\r\n```\r\n\r\n## IPC and HTTP\r\n\r\n### Tauri Commands\r\n- `ai_parse_task(input: String)` → calls AiService; returns ParsedTaskDTO\r\n- `ai_generate_recommendations(task_id: i64)` → returns RecommendationsDTO\r\n- `ai_plan_schedule()` → returns PlanDTO\r\n\r\n### HTTP Requests\r\n- Base URL: from settings (default `https://api.deepseek.com`)\r\n- Endpoint: `/v1/chat/completions`\r\n- Headers: `Authorization: Bearer <api_key>`, `Content-Type: application/json`\r\n- Payload patterns per operation with system/user messages and JSON schema hints\r\n- Timeout: 10s; Retry: 3 with backoff (1s/2s/4s)\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1. Invalid API Key (401)\r\n   - Handling: surface user error; suggest re-config; switch to offline upon repeat failures\r\n   - UI: toast \"API Key 无效\" + CTA to Settings\r\n2. Rate Limited (429)\r\n   - Handling: switch to offline; set cooldown; notify user\r\n   - UI: banner \"配额已用尽，已切换离线\"\r\n3. Timeout/Network Errors\r\n   - Handling: retry with backoff; then offline fallback\r\n   - UI: inline error with retry button\r\n4. Server Error (5xx)\r\n   - Handling: do not retry; offline fallback\r\n   - UI: notification + optional details panel\r\n\r\n## Security\r\n- Encrypt API key with AES-256-GCM; key from OS keyring\r\n- HTTPS only; redact sensitive logs\r\n- Do not persist full request/response; cache only normalized results\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing (Rust)\r\n- Mock DeepSeek HTTP using `httpmock` or `wiremock-rs`\r\n- Test: payload formation, error mapping, caching\r\n\r\n### Integration Testing (Rust + Frontend)\r\n- Simulate success/failure paths via mocked provider\r\n- Verify offline fallback and UI states\r\n\r\n### End-to-End (Playwright)\r\n- Scenario: configure API key → create task with natural text → see parsed fields and CoT → accept updates\r\n- Scenario: network off → fallback message → local parse works\r\n\r\n## UI Changes\r\n- Settings: add AI section (API Key input, test button, mode indicator)\r\n- Onboarding: step to configure API Key\r\n- Status badge in header: Online/Offline indicator\r\n- Task form: show \"AI 分析中\" and CoT collapsible panel\r\n\r\n## Metrics & Telemetry (Local Only)\r\n- Track callsToday, successRate, avgLatency in local store\r\n- Display in Settings; allow user to clear stats\r\n\r\n## Migration Plan\r\n- Add new tables via migration; idempotent\r\n- Implement provider without breaking existing CoT engine\r\n- Feature flag default: offline; prompt to enable online\r\n",
  "fileStats": {
    "size": 7986,
    "lines": 222,
    "lastModified": "2025-10-14T12:20:30.412Z"
  },
  "comments": []
}