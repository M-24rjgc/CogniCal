{
  "id": "snapshot_1759860601996_enrhaywzj",
  "approvalId": "approval_1759860601977_yq6ix4f0l",
  "approvalTitle": "Phase 0 Foundation - Design Document",
  "version": 1,
  "timestamp": "2025-10-07T18:10:01.996Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Phase 0 Foundation\r\n\r\n## Overview\r\n\r\nPhase 0 Foundation 的目标是为 CogniCal 提供一个生产可用的 Tauri 2 桌面应用骨架，集成 React 18 + TypeScript 前端和 Rust 后端，交付稳定的任务管理 CRUD 功能。本设计文档将对项目初始化、前后端分层、数据库建模、Tauri Commands、UI 组件与状态管理、错误处理、测试策略等进行详细设计，确保满足 `requirements.md` 中定义的 10 项需求并为后续阶段的智能化能力奠定基础。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- 遵循 `tech.md` 中推荐的技术栈：Tauri 2 + Rust 后端、React 18 + TypeScript + Vite 前端、Zustand 状态管理、Tailwind CSS + shadcn/ui UI 体系、SQLite 数据库。\r\n- 按照 `tech.md` 提供的数据架构和命名规范实现 `tasks`、`users` 基础表，并为未来的任务依赖、AI 日志等拓展字段留出扩展位。\r\n- 结合 `tech.md` 数据流范式，在设计中明确前端 → Tauri Command → Service → DB 的调用链，保证后续 AI 能力接入时只需扩展 Service 层。\r\n\r\n### Project Structure (structure.md)\r\n- 目录结构严格遵循 `structure.md`，前端位于 `src/`，后端位于 `src-tauri/src/`，并按照 commands / services / db / utils 分层。\r\n- 前端组件按照 `structure.md` 约定拆分：`components/`、`pages/`、`hooks/`、`stores/`、`types/`、`services/`、`utils/`，保证单一职责与可复用性。\r\n- 预置 `tests/`、`docs/`、`.vscode/` 等目录，为 Phase 0 完成后续持续集成、文档与测试奠定基础。\r\n\r\n## Code Reuse Analysis\r\n\r\n项目为全新启动，当前仓库尚无可复用代码，但将依赖成熟工具链与模板：\r\n\r\n### Existing Components to Leverage\r\n- **Tauri CLI (`pnpm dlx create-tauri-app`)**: 快速生成 Tauri 2 + React + Vite 项目骨架，减少样板代码。\r\n- **shadcn/ui CLI (`pnpm dlx shadcn-ui@latest init`)**: 生成标准化 Tailwind + Radix 组件，保证 UI 一致性。\r\n- **Lucide React Icons**: 直接复用图标组件库构建导航、按钮等图标。\r\n- **Zustand Devtools Middleware**: 便于调试全局状态。\r\n\r\n### Integration Points\r\n- **DeepSeek API**: Phase 0 暂不调用，仅在 `tauri.conf.json` 与 `src-tauri/src/utils/` 中预留接口，Phase 1 可直接接入。\r\n- **SQLite**: 通过 `rusqlite` 在后端建立数据库连接，配合 `tauri::api::path::app_data_dir` 获取用户本地数据目录。\r\n- **Tailwind + PostCSS + Prettier**: 和 Vite 集成，确保 CSS 与代码风格一致。\r\n\r\n## Architecture\r\n\r\n整体架构采用前后端分层 + 命令式 IPC 调用：\r\n\r\n```mermaid\r\ngraph TD\r\n    subgraph React UI (src/)\r\n        A[AppShell]\r\n        B[Pages (Dashboard/Tasks/Settings)]\r\n        C[Components (TaskList/TaskForm)]\r\n        D[Zustand Stores]\r\n        E[Tauri Service Wrapper]\r\n    end\r\n\r\n    subgraph Tauri Commands (src-tauri/src/commands)\r\n        F[task.rs]\r\n        G[app.rs (init)]\r\n    end\r\n\r\n    subgraph Services (src-tauri/src/services)\r\n        H[TaskService]\r\n        I[BootstrapService]\r\n    end\r\n\r\n    subgraph Database (src-tauri/src/db)\r\n        J[connection.rs]\r\n        K[schema.sql]\r\n        L[repositories]\r\n    end\r\n\r\n    A --> B --> C\r\n    B --> D\r\n    D --> E\r\n    E --> F\r\n    F --> H\r\n    H --> J\r\n    J --> K\r\n```\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: 每个 React 组件只关注展示/交互，Zustand store 专注状态管理，Rust service 专注业务逻辑。\r\n- **Component Isolation**: `TaskList`, `TaskTable`, `TaskFormDialog` 等组件解耦，复用 shadcn/ui 的 Button、Dialog、Form 控件。\r\n- **Service Layer Separation**: `TaskService` 管理任务 CRUD；`BootstrapService` 负责项目初始化和数据库迁移；未来可新增 `NotificationService`、`TrayService`。\r\n- **Utility Modularity**: `datetime.rs`, `validation.rs`, `error.rs` 等工具统一封装，前端 `validators.ts`, `formatters.ts` 与之对应。\r\n\r\n## Components and Interfaces\r\n\r\n### Component 1: AppShell (React)\r\n- **Purpose:** 提供 sidebar + header + main content 的主布局，负责路由切换、主题切换。\r\n- **Interfaces:**\r\n  - Props: none\r\n  - Hooks: `useTheme()`, `useSidebar()`\r\n- **Dependencies:** `@radix-ui/react-slot`, `lucide-react`, `ThemeProvider`, `Sidebar` 组件。\r\n- **Reuses:** shadcn/ui 的 Layout, Button, DropdownMenu; Tailwind utility classes。\r\n\r\n### Component 2: TaskListPage (React)\r\n- **Purpose:** 展示任务列表，提供过滤、排序、快速操作入口。\r\n- **Interfaces:**\r\n  - Reads store: `taskStore.tasks`, `taskStore.loading`\r\n  - Actions: `taskStore.fetchTasks()`, `taskStore.deleteTask(id)`\r\n- **Dependencies:** `TaskTable`, `TaskToolbar`, `TaskFormDialog`, `useTasks()` hook。\r\n- **Reuses:** `TauriApiService.getAllTasks()`，shadcn/ui Table, Badge 组件。\r\n\r\n### Component 3: TaskStore (Zustand)\r\n- **Purpose:** 管理任务状态、加载状态、错误状态，集中封装前端 CRUD。\r\n- **Interfaces:**\r\n  - State: `tasks: Task[]`, `selectedTaskId`, `loading`, `error`\r\n  - Actions: `fetchTasks`, `createTask`, `updateTask`, `deleteTask`, `selectTask`\r\n- **Dependencies:** `tauriApi.ts` 封装的 IPC 调用，`taskSchema` 验证函数。\r\n- **Reuses:** 将来 Phase 1 任务分解时可直接扩展 `tasks` 状态字段。\r\n\r\n### Component 4: TaskCommandHandlers (Rust)\r\n- **Purpose:** 暴露给前端的 Tauri Commands，实现任务 CRUD。\r\n- **Interfaces:**\r\n  - `#[tauri::command] async fn create_task(payload: TaskPayload) -> Result<Task>`\r\n  - `get_all_tasks`, `get_task_by_id`, `update_task`, `delete_task`\r\n- **Dependencies:** `TaskService`, `AppState`（包含 DB connection pool）\r\n- **Reuses:** `TaskRepository` 数据访问模块；错误类型 `AppError`。\r\n\r\n### Component 5: TaskService (Rust)\r\n- **Purpose:** 承载业务逻辑，处理验证、DTO ↔ 实体转换、事务。\r\n- **Interfaces:**\r\n  - `pub async fn create(&self, payload: CreateTaskInput) -> AppResult<TaskEntity>`\r\n  - 同步的 `get_all`, `get_by_id`, `update`, `delete`\r\n- **Dependencies:** `TaskRepository`, `Validator`, `chrono` 时间处理。\r\n- **Reuses:** 可在 Phase 1 添加 AI 建议字段的写入逻辑。\r\n\r\n### Component 6: BootstrapService (Rust)\r\n- **Purpose:** 第一次启动或版本升级时执行数据库初始化、迁移脚本。\r\n- **Interfaces:** `pub fn init(app_handle: &AppHandle) -> AppResult<()>`\r\n- **Dependencies:** `DbConnection`, `include_str!(\"schema.sql\")`\r\n- **Reuses:** Phase 1 可扩展为执行 Alembic/Tauri migration。\r\n\r\n## Data Models\r\n\r\n### Task (SQLite & Rust)\r\n```\r\nCREATE TABLE tasks (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    title TEXT NOT NULL CHECK(length(title) <= 200),\r\n    description TEXT NOT NULL CHECK(length(description) <= 2000),\r\n    priority TEXT NOT NULL CHECK(priority IN ('high','medium','low')),\r\n    status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending','in_progress','completed','cancelled')),\r\n    task_type TEXT NOT NULL CHECK(task_type IN ('work','study','life','other')),\r\n    planned_start_time TEXT NOT NULL,\r\n    deadline TEXT NOT NULL,\r\n    estimated_hours REAL NOT NULL,\r\n    actual_hours REAL,\r\n    tags TEXT,\r\n    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n    updated_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n);\r\n```\r\n- Rust `TaskEntity` 对应字段使用 `chrono::DateTime<Utc>` / `Option<f64>` / `serde_json::Value`。\r\n- TypeScript `Task` 类型匹配字段并使用 `string` 表示 ISO 时间。\r\n\r\n### User (SQLite & Rust)\r\n```\r\nCREATE TABLE users (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    name TEXT NOT NULL,\r\n    time_zone TEXT NOT NULL,\r\n    locale TEXT NOT NULL,\r\n    preferences TEXT, -- JSON store for theme, focus settings\r\n    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n    updated_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n);\r\n```\r\n- 单用户模式：默认插入一条主用户记录。\r\n- TypeScript `UserPreferences` 提供类型定义供设置页面使用。\r\n\r\n## Error Handling\r\n\r\n### Error Scenario 1: 数据库连接失败\r\n- **Handling:**\r\n  - `BootstrapService` 捕获连接异常，返回 `AppError::DatabaseUnavailable`。\r\n  - 前端在 `TaskStore.fetchTasks` 捕获错误并显示带重试按钮的 toast。\r\n  - 记录错误到 `logs/app.log`。\r\n- **User Impact:** 用户看到“数据库初始化失败，请重试或检查磁盘权限”的提示，可点击“重试”。\r\n\r\n### Error Scenario 2: 表单验证失败\r\n- **Handling:**\r\n  - 前端使用 `zod` schema 即时验证；若失败，阻止提交并高亮错误字段。\r\n  - 如果绕过前端验证，Rust 命令通过 `validator` 再次验证并返回结构化错误（字段 + 消息）。\r\n- **User Impact:** 在 TaskFormDialog 中显示字段级错误信息，提交按钮禁用直至问题解决。\r\n\r\n### Error Scenario 3: Tauri Command Panic\r\n- **Handling:**\r\n  - 使用 `tauri::async_runtime::spawn` + `anyhow::Result`，所有命令返回 `Result`，统一转换为 `AppError`。\r\n  - 设置 `tauri.conf.json` 中的 `error-dialogs` 为 true，开发模式显示详细调试信息。\r\n- **User Impact:** 前端弹出错误提示，日志捕获详细堆栈，避免应用崩溃。\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- **前端**: 使用 Vitest + React Testing Library 对 `TaskStore`、`TaskForm` 验证表单逻辑、状态更新。\r\n- **后端**: 使用 `cargo test` 对 `TaskService`、`TaskRepository` 进行单元测试，采用临时内存数据库。\r\n- **工具方法**: 对 `datetime.rs`, `validators.rs` 等工具函数编写快照测试。\r\n\r\n### Integration Testing\r\n- **前后端 IPC**: 使用 `@tauri-apps/api` mock + Vitest，模拟 `invoke` 调用验证命令参数格式。\r\n- **数据库集成**: 在 `tests/integration/` 中使用 `sqlite` 临时文件测试 `TaskService` 的 CRUD 流程。\r\n- **UI 集成**: 使用 Storybook (Phase 0 optional) 或直接在 Vitest 中对 `TaskListPage` 进行集成测试。\r\n\r\n### End-to-End Testing\r\n- **工具**: Playwright + Tauri 测试 runner。\r\n- **场景**:\r\n  1. 用户首次启动应用，看到空任务列表。\r\n  2. 创建任务 → 任务出现在列表中。\r\n  3. 编辑任务 → 字段更新反映在列表。\r\n  4. 删除任务 → 列表中移除。\r\n- **环境**: CI 中使用 GitHub Actions + `tauri-apps/tauri-action` 打包并运行 E2E。\r\n\r\n---\r\n\r\n通过该设计，Phase 0 将交付一个可运行、可测试、易扩展的桌面应用基础架构，满足所有功能与非功能需求，并为 Phase 1 引入 AI 能力、CoT 推理、双智能体系统提供清晰的扩展点和技术路径。\r\n",
  "fileStats": {
    "size": 10654,
    "lines": 210,
    "lastModified": "2025-10-07T18:09:50.505Z"
  },
  "comments": []
}