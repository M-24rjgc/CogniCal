{
  "id": "snapshot_1760733132216_wf38mbmn0",
  "approvalId": "approval_1760733132136_xr6ea87c1",
  "approvalTitle": "interactive-onboarding design",
  "version": 1,
  "timestamp": "2025-10-17T20:32:12.216Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nDeliver an interactive onboarding stack that introduces first-time CogniCal users to the dashboard, AI task flows, and required settings while keeping contextual help and a reusable help hub available later. The solution wraps three layers:\r\n\r\n1. **Tour Orchestrator** – a Driver.js-powered walkthrough that runs on first launch and can be rerun manually.\r\n2. **Contextual Help Controls** – lightweight `?` affordances attached to dense cards and panels that explain purpose/links without navigation.\r\n3. **Help Center Dialog** – a consolidated dialog reachable from sidebar, command palette, or keyboard shortcut with onboarding status, shortcuts, and API guidance.\r\n\r\nAll surfaces share a single onboarding state service so progress and completion flags persist locally.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- Stay within the React 18 + TypeScript + Vite stack, using existing Zustand state management for onboarding state with `zustand/middleware` `persist` helper for local storage.\r\n- Reuse the already installed `driver.js` dependency for step highlight UX, matching the recommended modern UI tooling.\r\n- Honor accessibility emphasis by ensuring keyboard focus management and Escape handlers in popovers/dialogs, aligning with shadcn/ui + Radix patterns noted in tech.md.\r\n\r\n### Project Structure (structure.md)\r\n- New UI components land under `src/components/onboarding/` and `src/components/help/` to keep feature-specific code grouped.\r\n- The orchestrator integrates at `src/routes/index.tsx` alongside existing providers (similar to command palette wiring) to ensure availability for all routes.\r\n- State store defined in `src/stores/onboardingStore.ts` next to current Zustand stores, following structure.md conventions.\r\n- Shared copy/constants stored in `src/utils/onboarding.ts` to keep separation of data from presentation.\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **`AppShell` + `RootLayout`**: host the tour orchestrator and help hub so all routes inherit functionality.\r\n- **`KeyboardShortcutContext` + command palette**: add entries for help hub and tour replay to maintain unified shortcut/command semantics.\r\n- **`KeyboardShortcutsHelp` dialog**: embed inside the help hub instead of building another shortcuts viewer.\r\n- **`useSettingsStore`**: surface DeepSeek API status inside the help hub without duplicating settings logic.\r\n\r\n### Integration Points\r\n- **Navigation/System State**: `RootLayout` toggles the help dialog and triggers tour start based on store flags.\r\n- **Persistence**: Leverage Zustand `persist` middleware with `localStorage` (falls back to in-memory if unavailable) for onboarding progress. No backend changes required.\r\n- **Accessibility Utilities**: reuse shadcn/ui dialog primitives for the help hub and popover primitives for contextual help.\r\n\r\n## Architecture\r\n\r\nThe onboarding system layers on top of existing layout providers, sharing central state and context triggers.\r\n\r\n```mermaid\r\ngraph TD\r\n    subgraph Layout\r\n        RL[RootLayout]\r\n    end\r\n    subgraph Stores\r\n        OS[(onboardingStore)]\r\n        SS[(settingsStore)]\r\n    end\r\n    subgraph UI\r\n        OO[OnboardingOrchestrator]\r\n        HC[HelpCenterDialog]\r\n        HP[HelpPopover]\r\n    end\r\n\r\n    RL --> OO\r\n    RL --> HC\r\n    RL --> HP\r\n    OO --> OS\r\n    HC --> OS\r\n    HC --> SS\r\n    HP --> OS\r\n\r\n    OO -.->|start/end tour| HC\r\n    HC -.->|replay tour| OO\r\n    RL -->|keyboard shortcuts/command palette| HC\r\n```\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: `OnboardingOrchestrator.tsx` only manages Driver.js lifecycle; dialog contents split into subcomponents (status card, resources list, shortcut embed).\r\n- **Component Isolation**: Contextual help popovers accept copy via props; no direct store coupling to keep them reusable.\r\n- **Service Layer Separation**: `onboardingStore.ts` encapsulates persistence and exposes imperative helpers (`markStepComplete`, `resetTour`, `recordDismissal`).\r\n- **Utility Modularity**: Tour step definitions exported from `utils/onboarding.ts` and consumed by orchestrator and tests.\r\n\r\n## Components and Interfaces\r\n\r\n### OnboardingOrchestrator\r\n- **Purpose:** Attach Driver.js tour to DOM anchors, monitor completion/dismissal, and respond to manual replay events.\r\n- **Interfaces:** Props-less component hooking into store selectors; exposes `window.dispatchEvent` listener for `onboarding:replay` to keep integration decoupled.\r\n- **Dependencies:** `driver.js`, `onboardingStore`, `useLocation` (to advance step anchors), `KeyboardShortcutContext` for overlay gating.\r\n- **Reuses:** Existing `KeyboardShortcutContext` to avoid shortcut conflicts while tour overlays are visible.\r\n\r\n### HelpCenterDialog\r\n- **Purpose:** Provide a Radix dialog summarizing onboarding status, quick actions (replay tour, open shortcuts), FAQ copy, and API key guidance.\r\n- **Interfaces:** Controlled via `open`/`onOpenChange` from `RootLayout`; internally composes sub-panels: `HelpCenterHeader`, `OnboardingSummaryCard`, `ResourceLinks`, `KeyboardShortcutSection` (delegates to `KeyboardShortcutsHelp`).\r\n- **Dependencies:** `onboardingStore`, `useSettingsStore`, `KeyboardShortcutsHelp` component.\r\n- **Reuses:** Shadcn/ui dialog primitives, existing keyboard shortcuts data, and `Button`/`Badge` components.\r\n\r\n### HelpPopover\r\n- **Purpose:** Small `?` icon button + Radix popover wrapper showing contextual explanations and optional actions.\r\n- **Interfaces:** `title`, `description`, optional `links[]`, optional `onReplayTour`, `ariaId` props.\r\n- **Dependencies:** Radix Popover, `Button` (ghost variant), `cn` utility.\r\n- **Reuses:** Shared copy provided via `helpCopy` map kept in `utils/onboarding.ts` to avoid duplication.\r\n\r\n### Onboarding Store (`useOnboardingStore`)\r\n- **Purpose:** Centralize onboarding progress flags and operations.\r\n- **Interfaces:**\r\n  - `hasCompletedTour: boolean`\r\n  - `lastCompletedStepId?: string`\r\n  - `dismissedAt?: string`\r\n  - `setHasCompletedTour(boolean)`\r\n  - `markStepComplete(stepId)`\r\n  - `resetTour()`\r\n  - `recordDismissal(stepId)`\r\n  - `shouldAutoLaunchTour(): boolean`\r\n- **Dependencies:** Zustand + `persist` middleware.\r\n- **Reuses:** None; purely new store.\r\n\r\n## Data Models\r\n\r\n### OnboardingProgress (TypeScript)\r\n```\r\ninterface OnboardingProgress {\r\n  hasCompletedTour: boolean;\r\n  completedStepIds: string[];\r\n  lastStepId?: string;\r\n  dismissedAt?: string;\r\n  version: number; // for future migrations\r\n}\r\n```\r\n\r\n### HelpResourceLink\r\n```\r\ninterface HelpResourceLink {\r\n  id: string;\r\n  label: string;\r\n  href: string;\r\n  icon?: LucideIcon;\r\n  hotkey?: string;\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenario 1: Missing Anchor Elements\r\n- **Handling:** Orchestrator checks `document.querySelector` results; if a target is missing it skips the step and logs a warning using `console.warn` (DEV) while continuing.\r\n- **User Impact:** Tour continues with remaining steps; help hub displays a notice allowing manual replay once relevant panel is loaded.\r\n\r\n### Error Scenario 2: Persisted State Corruption\r\n- **Handling:** `persist` middleware `onRehydrateStorage` validates schema; on mismatch, reset to defaults and flag `wasReset` so UI can prompt user to rerun tour.\r\n- **User Impact:** User sees help hub card recommending rerunning the tour; no blocking behavior.\r\n\r\n### Error Scenario 3: Driver.js Runtime Failure\r\n- **Handling:** Catch orchestrator initialization errors and set `tourStatus` to `disabled`, preventing further auto-runs while showing a fallback toast via `uiStore.pushToast`.\r\n- **User Impact:** User receives notification that guided tour is unavailable but can read help hub content.\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- Validate `useOnboardingStore` transitions (completion flags, reset logic, version migrations).\r\n- Snapshot test `HelpPopover` to ensure accessibility attributes, and verify escape/close callbacks.\r\n- Test `utils/onboarding.ts` step definitions to ensure each step exports expected selectors and copy.\r\n\r\n### Integration Testing\r\n- Add Vitest React Testing Library specs covering `HelpCenterDialog` to confirm data renders (API key warning, onboarding status) and actions dispatch (replay tour event, shortcut dialog toggle).\r\n- Ensure `RootLayout` integration prevents tour auto-launch when `hasCompletedTour` is true and resumes when store reset.\r\n\r\n### End-to-End Testing\r\n- Extend Playwright suite with scenarios:\r\n  1. Fresh profile (cleared storage) auto-opens tour, stepping through until completion updates help hub.\r\n  2. Mid-tour reload preserves progress and resumes from next step.\r\n  3. Help popover reachable via keyboard and closes on Escape without losing task edits.\r\n  4. Help hub accessible via Shift+/ shortcut and provides API key CTA when missing.\r\n",
  "fileStats": {
    "size": 8857,
    "lines": 166,
    "lastModified": "2025-10-17T20:32:06.028Z"
  },
  "comments": []
}