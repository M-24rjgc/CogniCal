{
  "id": "snapshot_1760323572161_ak13gsl3d",
  "approvalId": "approval_1760323571960_m2tvsbo7s",
  "approvalTitle": "Phase 4 Productivity Optimization Design",
  "version": 1,
  "timestamp": "2025-10-13T02:46:12.161Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Phase 4 Productivity Optimization\r\n\r\n## Overview\r\nPhase 4 turns CogniCal into a proactive productivity co-pilot built on the newly approved requirements. The release adds a multi-dimensional scoring engine, AI-backed planning flows, workload safeguards, rhythm-aware nudges, and transparent feedback/community tooling. The design preserves the privacy-first desktop architecture: all scoring, telemetry, and feedback storage remain local, while DeepSeek-powered reasoning is invoked only when connectivity allows. The solution closes the loop between analytics signals and actionable guidance without introducing paid tiers or breaking the open-source contract.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- Extend the Rust service layer (`analytics_service`, `recommendation_service`, `forecasting_service`, `feedback_service`, `community_service`) and expose functionality via typed Tauri commands, keeping IPC boundaries thin.\r\n- Continue using SQLite through the existing pooled connection infrastructure; batch jobs run in the Rust scheduler and communicate results to the React client through cached queries exposed over Zustand/React Query hooks.\r\n- DeepSeek access stays encapsulated inside `ai_service` helpers so prompt construction, CoT parsing, and fallback behaviours are reusable and auditable; all outbound requests strip sensitive payloads per the privacy requirements.\r\n- Maintain the dual-agent-ready architecture: new services emit structured events that the forthcoming agents can consume without rework.\r\n\r\n### Project Structure (structure.md)\r\n- Frontend additions live alongside existing analytics/planning components (`src/components/analytics`, `src/components/tasks`, new `src/components/productivity` folder if needed) and reuse the shared UI primitives in `src/components/ui`.\r\n- Shared hooks are added under `src/hooks` (`useProductivityScore`, `useRecommendations`, `useWellness`, `useCommunityExports`) backed by new Zustand slices in `src/stores`.\r\n- Rust modules follow the established layout (`src-tauri/src/services/*`, `src-tauri/src/commands/*`, `src-tauri/src/db/models/*`) with single-responsibility files and `mod.rs` re-exports.\r\n- Tests mirror feature placement: Vitest suites in `src/__tests__`, Playwright scenarios in `e2e/`, and Rust integration tests in `tests/integration`.\r\n\r\n## Code Reuse Analysis\r\nPhase 4 builds on the analytics foundation from Phase 3 and the planning utilities introduced earlier phases. Minimal net-new surface area is created; instead, existing stores, hooks, and UI scaffolding are extended.\r\n\r\n### Existing Components to Leverage\r\n- **`useAnalytics` hook & `AnalyticsOverview`**: incorporate productivity score cards, historical charting, and risk banners without rebuilding dashboard scaffolding.\r\n- **`TaskPlanningPanel` & `TaskAiParsePanel`**: host the expanded recommendation flows, adding multi-option plan presentation and conflict resolution actions.\r\n- **`taskStore` / `planningStore`**: persist user decisions, capacity preferences, and scheduling metadata for the learning loop.\r\n- **`toast-provider` & `Dialog` primitives**: surface wellness nudges, opt-out confirmations, and community export prompts consistently.\r\n- **`tauriApi` service**: extend with typed functions (`getProductivityScore`, `generateRecommendations`, `getWorkloadForecast`, `logAiFeedback`, `createCommunityExport`).\r\n\r\n### Integration Points\r\n- **Tauri Commands**: new commands `analytics_get_productivity_score`, `planning_generate_recommendations`, `analytics_get_workload_forecast`, `wellness_get_nudges`, `feedback_submit`, `community_export_bundle` wire the UI to Rust services.\r\n- **SQLite Models**: enrich existing analytics snapshots, add dedicated tables for recommendations, forecasts, feedback, and exports while reusing the migration tooling.\r\n- **DeepSeek API**: invoked via the shared `ai_service` with uniform retry/timeout handling; outputs feed CoT/MCTS helpers for recommendation quality.\r\n- **Desktop Notifications**: use the existing Tauri notification abstraction to deliver deferred nudges and risk alerts outside the active UI.\r\n\r\n## Architecture\r\nThe solution keeps a clear separation between presentation, state orchestration, service access, and persistence. Local batch workers compute scores and forecasts nightly, while on-demand requests flow through IPC to Rust services and optionally call DeepSeek.\r\n\r\n```mermaid\r\ngraph TD\r\n    UI[React Productivity Surfaces] --> Hooks[Hooks & Zustand Stores]\r\n    Hooks --> IPC[Tauri IPC Commands]\r\n    IPC --> Services[Rust Service Layer]\r\n    Services --> DB[(SQLite + Cache)]\r\n    Services --> DeepSeek[DeepSeek API]\r\n    Services --> Scheduler[Cron & Notification Jobs]\r\n    Hooks --> Notifications[Tauri Notifications]\r\n```\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: each new Rust service module covers one domain (scores, recommendations, forecasts, wellness, feedback, community exports).\r\n- **Component Isolation**: UI surfaces split into focused cards/panels (score breakdown, recommendation drawer, wellness center) that compose inside existing dashboards.\r\n- **Service Layer Separation**: command handlers remain thin; heavy lifting lives in services that orchestrate data access, AI calls, and rule evaluation.\r\n- **Utility Modularity**: shared scoring formulas, capacity heuristics, and redaction helpers reside in `src-tauri/src/utils`, enabling reuse in future agent services.\r\n\r\n## Components and Interfaces\r\n\r\n### Component 1 ‚Äî `ProductivityScoreEngine` (Rust)\r\n- **Purpose:** Compute composite and per-dimension scores, persist daily snapshots, and expose explanations.\r\n- **Interfaces:** `fn calculate_scores(user_id) -> ScoreBundle`, `fn get_history(range) -> Vec<ScoreSnapshot>`.\r\n- **Dependencies:** `analytics_service` data loaders, `sqlite::analytics_snapshots`, optional DeepSeek summariser for explanation text.\r\n- **Reuses:** Existing analytics aggregations, CoT summariser utilities for rationale strings.\r\n\r\n### Component 2 ‚Äî `ProductivityScorePanel` (React)\r\n- **Purpose:** Render the 0-100 score, dimension chips, hoverable explanations, and trend toggles.\r\n- **Interfaces:** Props derived from `useProductivityScore` hook; emits `onExport`, `onDimensionSelect` events for analytics navigation.\r\n- **Dependencies:** `useAnalyticsStore`, `useProductivityScore`, Recharts for trend visualisation.\r\n- **Reuses:** `SummaryCards`, `ProductivityTrendChart` layout and skeleton states.\r\n\r\n### Component 3 ‚Äî `RecommendationOrchestrator` (Rust)\r\n- **Purpose:** Generate ‚â•3 scheduling scenarios, detect conflicts, apply user prefs, and log decisions.\r\n- **Interfaces:** `async fn generate_plan(context) -> Vec<PlanOption>`, `fn record_decision(decision)`.\r\n- **Dependencies:** `planning_service`, `ai_service` (DeepSeek), `mcts_solver`, `sqlite::recommendation_sessions`.\r\n- **Reuses:** Existing MCTS utilities, task fetching helpers, calendar conflict detectors.\r\n\r\n### Component 4 ‚Äî `TaskPlanningPanel` Extensions (React)\r\n- **Purpose:** Display ranked plan options with conflict badges, provide adjustment actions, and capture feedback.\r\n- **Interfaces:** Expanded store slice with `requestRecommendations`, `acceptPlan`, `snoozePlan`, `cacheFallbackPlan`.\r\n- **Dependencies:** `usePlanning`, `taskStore`, `planningStore`, `Dialog`/`Sheet` primitives.\r\n- **Reuses:** Current AI plan UI, `ConflictResolutionSheet`, toast helpers.\r\n\r\n### Component 5 ‚Äî `WorkloadForecastService` & `CapacityGuard` (Rust)\r\n- **Purpose:** Run nightly to predict workload horizons, annotate risk levels, and expose drill-down data.\r\n- **Interfaces:** `fn enqueue_daily_job()`, `fn get_forecast(range) -> ForecastBundle`.\r\n- **Dependencies:** `analytics_service`, `planning_service`, `sqlite::workload_forecasts`, scheduler utilities.\r\n- **Reuses:** Existing batch job scheduler, time series smoothing helpers.\r\n\r\n### Component 6 ‚Äî `WellnessNudgeManager` (Rust + React)\r\n- **Purpose:** Track focus streaks, trigger rest reminders, respect quiet hours, and adapt cadence.\r\n- **Interfaces:** `fn evaluate_nudges(now) -> Vec<Nudge>`, `fn record_response(response)`; frontend hook `useWellness` surfaces pending nudges.\r\n- **Dependencies:** `settingsStore` for thresholds, `sqlite::session_metrics`, Tauri notification API.\r\n- **Reuses:** `toast-provider`, `Notification` utilities, session tracking instrumentation from Phase 3.\r\n\r\n### Component 7 ‚Äî `FeedbackCapturePipeline` (Full stack)\r\n- **Purpose:** Store inline üëç/üëé feedback with context, provide retry prompts, and synthesise weekly digests.\r\n- **Interfaces:** Command `feedback_submit`, query `feedback_get_digest`; hook `useFeedback` for UI integration.\r\n- **Dependencies:** `sqlite::ai_feedback`, `ai_service` for optional regenerate, `settingsStore` privacy flags.\r\n- **Reuses:** Existing feedback modals (if any) and toast messaging.\r\n\r\n### Component 8 ‚Äî `CommunityTransparencyCenter`\r\n- **Purpose:** Surface OSS assurances, enable export of anonymised usage bundles, and list detected plugins.\r\n- **Interfaces:** Commands `community_export_bundle`, `community_detect_plugins`; React sheet `CommunityExportDialog`.\r\n- **Dependencies:** `community_service`, file system access, cache of plugin metadata.\r\n- **Reuses:** `Card`, `Dialog`, file export utilities already in analytics export flow.\r\n\r\n## Data Models\r\n\r\n### `productivity_scores`\r\n```\r\n- snapshot_date: TEXT PRIMARY KEY (ISO date)\r\n- composite_score: REAL NOT NULL\r\n- dimension_scores: TEXT NOT NULL -- JSON map {\"completion\": number, ...}\r\n- weight_breakdown: TEXT NOT NULL -- JSON map of weights\r\n- explanation: TEXT -- CoT summary (markdown-safe)\r\n- created_at: TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n```\r\n\r\n### `recommendation_sessions`\r\n```\r\n- id: INTEGER PRIMARY KEY\r\n- generated_at: TEXT NOT NULL\r\n- context_hash: TEXT NOT NULL\r\n- plans: TEXT NOT NULL -- JSON array of plan options\r\n- source: TEXT NOT NULL CHECK(source IN ('deepseek', 'cached', 'heuristic'))\r\n- network_status: TEXT NOT NULL CHECK(network_status IN ('online', 'offline'))\r\n- expires_at: TEXT\r\n```\r\n\r\n### `recommendation_decisions`\r\n```\r\n- id: INTEGER PRIMARY KEY\r\n- session_id: INTEGER NOT NULL REFERENCES recommendation_sessions(id)\r\n- user_action: TEXT NOT NULL CHECK(user_action IN ('accepted', 'rejected', 'adjusted'))\r\n- adjustment_payload: TEXT\r\n- responded_at: TEXT NOT NULL\r\n- preference_tags: TEXT -- JSON array\r\n```\r\n\r\n### `workload_forecasts`\r\n```\r\n- horizon: TEXT NOT NULL CHECK(horizon IN ('7d', '14d', '30d'))\r\n- generated_at: TEXT NOT NULL\r\n- risk_level: TEXT NOT NULL CHECK(risk_level IN ('ok', 'warning', 'critical'))\r\n- total_hours: REAL NOT NULL\r\n- capacity_threshold: REAL NOT NULL\r\n- contributing_tasks: TEXT NOT NULL -- JSON array\r\n- confidence: REAL NOT NULL\r\n- PRIMARY KEY (horizon, generated_at)\r\n```\r\n\r\n### `wellness_events`\r\n```\r\n- id: INTEGER PRIMARY KEY\r\n- window_start: TEXT NOT NULL\r\n- trigger_reason: TEXT NOT NULL CHECK(trigger_reason IN ('focus_streak', 'work_streak'))\r\n- recommended_break_minutes: INTEGER NOT NULL\r\n- suggested_micro_task: TEXT\r\n- response: TEXT CHECK(response IN ('completed', 'snoozed', 'ignored'))\r\n- response_at: TEXT\r\n- deferral_count: INTEGER NOT NULL DEFAULT 0\r\n```\r\n\r\n### `ai_feedback`\r\n```\r\n- id: INTEGER PRIMARY KEY\r\n- surface: TEXT NOT NULL CHECK(surface IN ('score', 'recommendation', 'forecast'))\r\n- session_id: INTEGER\r\n- sentiment: TEXT NOT NULL CHECK(sentiment IN ('up', 'down'))\r\n- note: TEXT\r\n- prompt_snapshot: TEXT NOT NULL\r\n- context_snapshot: TEXT NOT NULL\r\n- created_at: TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n- anonymized: BOOLEAN NOT NULL DEFAULT 1\r\n```\r\n\r\n### `community_exports`\r\n```\r\n- id: INTEGER PRIMARY KEY\r\n- generated_at: TEXT NOT NULL\r\n- payload_path: TEXT NOT NULL\r\n- metrics_summary: TEXT NOT NULL -- JSON object\r\n- includes_feedback: BOOLEAN NOT NULL DEFAULT 0\r\n- checksum: TEXT NOT NULL\r\n```\r\n\r\nExisting tables (`analytics_snapshots`, `task_preferences`) gain extra columns for rest compliance metrics and capacity thresholds through migrations.\r\n\r\n## Error Handling\r\n\r\n### Error Scenario 1 ‚Äî DeepSeek Unavailable\r\n- **Handling:** `RecommendationOrchestrator` falls back to cached `recommendation_sessions` (<=7 days old) or heuristic schedules; UI shows a warning chip indicating offline mode.\r\n- **User Impact:** User receives usable plans with a banner prompting retry when the network is restored.\r\n\r\n### Error Scenario 2 ‚Äî Insufficient Historical Data\r\n- **Handling:** `WorkloadForecastService` tags forecasts with `confidence < 0.4`, switches to heuristic calculations, and records the state for analytics.\r\n- **User Impact:** Dashboard displays \"‰ΩéÁΩÆ‰ø°Â∫¶\" labels and guidance for collecting more data.\r\n\r\n### Error Scenario 3 ‚Äî Feedback Opt-Out\r\n- **Handling:** Feedback submission commands check privacy flags and short-circuit with a `403`-style response; frontend hides controls and offers one-click purge of historical feedback.\r\n- **User Impact:** Users see confirmation that data collection is disabled and past entries were removed.\r\n\r\n### Error Scenario 4 ‚Äî Export Package Generation Failure\r\n- **Handling:** `CommunityTransparencyCenter` writes structured logs, retries once with exponential back-off, and surfaces a toast plus action link to view logs.\r\n- **User Impact:** Users get a clear error state with steps to retry or review logs; no partial files left on disk.\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- Rust: cover scoring formula calculations, risk classifier thresholds, nudge cadence adjustments, and feedback anonymisation helpers.\r\n- TypeScript: test new hooks (`useProductivityScore`, `useRecommendations`, `useWellness`, `useCommunityExports`) with mocked IPC responses and store updates.\r\n\r\n### Integration Testing\r\n- Rust integration tests ensure nightly jobs write correct snapshots, forecast risk banners reflect task backlog scenarios, and feedback opt-out flows wipe stored entries.\r\n- Frontend Vitest suites validate rendering of score breakdowns, conflict resolution actions, and export confirmation flows using mocked stores and IPC stubs.\r\n\r\n### End-to-End Testing\r\n- Playwright scenarios cover accepting AI recommendations, experiencing capacity warnings, responding to wellness nudges, submitting AI feedback, and generating community export bundles (both online/offline paths).\r\n- Smoke E2E test updated to assert the analytics dashboard now displays the productivity score and shows fallback messaging when DeepSeek is unreachable.\r\n",
  "fileStats": {
    "size": 14508,
    "lines": 219,
    "lastModified": "2025-10-13T02:46:03.071Z"
  },
  "comments": []
}