{
  "id": "snapshot_1760542970556_f2xrrd1xn",
  "approvalId": "approval_1760542970495_n4g5jbcf4",
  "approvalTitle": "ai-integration-simplification tasks",
  "version": 1,
  "timestamp": "2025-10-15T15:42:50.556Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks: AI Integration Simplification\r\n\r\n- [ ] 1. Prune legacy CoT provider stack in ai_service.rs\r\n  - File(s): src-tauri/src/services/ai_service.rs, src-tauri/src/services/ai_cache.rs, src-tauri/src/services/cot_engine.rs (delete), src-tauri/src/models/ai_types.rs\r\n  - Purpose: Remove provider multiplexing, delete LocalCotProvider, ensure config/cache paths align with single DeepSeek provider, and drop unused metadata fields.\r\n  - _Leverage: existing cache put/get helpers, CryptoVault config loader, current DeepSeekProvider implementation_\r\n  - _Requirements: Requirement 1, Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Senior Rust Engineer (Tauri) | Task: Refactor ai_service.rs to remove LocalCotProvider and provider switching, delete cot_engine module, update cache writes/reads for single provider, and adjust TaskParseResponse telemetry structure per design.md. Ensure migrations or code cleanly remove dead references and compilation succeeds. | Restrictions: Do not break existing public command signatures; keep cache schema unchanged; ensure deleted modules have no lingering references. | _Leverage: ai_service.rs cache helpers, CryptoVault loader, models/ai_types.rs_| _Requirements: R1, R3 | Success: Crate builds without cot_engine references, only DeepSeekProvider remains, telemetry metadata matches design._\r\n\r\n- [ ] 2. Simplify DeepSeekProvider invoke logic and normalize errors\r\n  - File(s): src-tauri/src/services/ai_service.rs (DeepSeekProvider section), src-tauri/src/services/prompt_templates.rs, src-tauri/src/error.rs (if needed)\r\n  - Purpose: Update prompt template to include structured JSON example, force `response.json()` parsing, add correlation IDs, and centralize error code mapping (MISSING_API_KEY, HTTP_TIMEOUT, RATE_LIMITED, INVALID_RESPONSE, DEEPSEEK_UNAVAILABLE).\r\n  - _Leverage: current invoke_chat, prompt builder, AppError constructors_\r\n  - _Requirements: Requirement 1, Requirement 2_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Backend Engineer | Task: Revise DeepSeekProvider::invoke_chat to use Response::json, attach UUID correlation IDs, and map errors to new AppError codes per design.md; update prompt_templates::task_parsing_system_prompt with example JSON instructions. | Restrictions: Keep request payload structure compatible with existing DeepSeek API; never log secrets; ensure correlation ID travels in metadata. | _Leverage: reqwest client, prompt_templates.rs_ | _Requirements: R1, R2 | Success: Unit tests cover error mapping; prompt contains example JSON; logs show correlation IDs without sensitive data._\r\n\r\n- [ ] 3. Update Tauri command and TS bridge for normalized errors\r\n  - File(s): src-tauri/src/commands/ai_commands.rs, src/services/tauriApi.ts, src/types/task.ts, src/types/settings.ts, src/utils/errors.ts (if exists)\r\n  - Purpose: Propagate new error codes via CommandError, adjust TypeScript AppError typing, and ensure parseTask wrapper surfaces user-friendly messages.\r\n  - _Leverage: existing CommandError::from mapping, tauriApi parseTask implementation, validators_\r\n  - _Requirements: Requirement 2_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Full-stack TypeScript/Rust Engineer | Task: Update tasks_parse_ai_impl to include correlation IDs in debug info and map new AppError codes; extend tauriApi.ts and related types to recognize MISSING_API_KEY, HTTP_TIMEOUT, RATE_LIMITED, INVALID_RESPONSE, DEEPSEEK_UNAVAILABLE with friendly messages per design. | Restrictions: Maintain current IPC command names; validations must still use Zod; do not duplicate error strings across files—centralize where appropriate. | _Leverage: CommandError struct, parseTaskParseResult validator_ | _Requirements: R2 | Success: Frontend receives typed AppError, unit tests for tauriApi pass, correlation IDs available for diagnostics._\r\n\r\n- [ ] 4. Refactor useTaskForm AI state management\r\n  - File(s): src/hooks/useTaskForm.ts, src/types/task.ts, src/stores/uiStore.ts (if toast handling adjusted)\r\n  - Purpose: Simplify TaskFormAiState to idle/loading/success/error, remove strategy/source fields, persist user edits across retries, and expose correlationId when present.\r\n  - _Leverage: existing form.setValue logic, applyAiResult function_\r\n  - _Requirements: Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Hooks Specialist | Task: Streamline AI state in useTaskForm by removing fallback strategy logic, ensuring user-modified fields remain untouched unless explicitly overridden, and handling new error codes/correlation IDs. Update associated types accordingly. | Restrictions: Maintain backwards compatibility for other consumers of the hook; keep Zod validation intact; avoid introducing new global state. | _Leverage: react-hook-form APIs, existing applyAiResult helper_ | _Requirements: R3 | Success: Hook tests cover success/error/retry, state no longer references offline/cache source, manual edits survive retries._\r\n\r\n- [ ] 5. Redesign Task AI panel UI for single-provider flow\r\n  - File(s): src/components/tasks/TaskAiParsePanel.tsx, src/components/tasks/TaskCotViewer.tsx (delete), related CSS or icon imports\r\n  - Purpose: Reduce panel to textarea + parse button + inline success/error feedback, remove CoT feedback and offline badges, show API key status badge and simple retry action.\r\n  - _Leverage: existing Button, Alert, Textarea components, toast utilities_\r\n  - _Requirements: Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React UI Engineer | Task: Update TaskAiParsePanel to match simplified UX—single parse CTA, inline success indicator, error card with retry, optional Settings link when key missing; remove CoT viewer usage and delete redundant components. | Restrictions: Maintain accessibility (labels, aria); preserve responsive layout; ensure component tree has no unused imports. | _Leverage: shadcn/ui components, pushToast helper_ | _Requirements: R3 | Success: Component snapshot tests updated; CoT viewer no longer rendered; UI displays clear actions per design mocks._\r\n\r\n- [ ] 6. Adjust Settings page AI status section\r\n  - File(s): src/pages/Settings.tsx, src/stores/settingsStore.ts if needed\r\n  - Purpose: Reflect single-provider status badges (在线/未配置/不可用), remove offline/cache references, ensure test connection uses normalized statuses.\r\n  - _Leverage: existing loadAiStatus/testAiConnection actions, Badge components_\r\n  - _Requirements: Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Developer | Task: Simplify Settings AI section to show DeepSeek status only, update copy per design, ensure status refresh/test flows handle new error codes gracefully. | Restrictions: Do not alter non-AI settings; preserve localization-ready text structure; maintain skeleton/loading states. | _Leverage: useAI hook, existing badges/cards_ | _Requirements: R3 | Success: Settings page reflects single-provider wording, tests updated, no references to offline/cache remain._\r\n\r\n- [ ] 7. Extend Rust unit and integration tests for AI service\r\n  - File(s): src-tauri/tests/ai_service_tests.rs, new src-tauri/tests/deepseek_mock_tests.rs (if needed), Cargo.toml (for test deps)\r\n  - Purpose: Cover error mapping, missing key, invalid JSON, timeout, correlation ID propagation, and cache hit metadata.\r\n  - _Leverage: existing prompt payload tests, AppError assertions_\r\n  - _Requirements: Requirement 2_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust QA Engineer | Task: Add unit/integration tests verifying new error codes and correlation IDs using mock HTTP server; ensure cache metadata includes cache_hit flag. | Restrictions: Tests must not hit real network; keep runtime under 60s; guard new dependencies behind dev-dependencies. | _Leverage: reqwest::Client tests, wiremock or httpmock crates_ | _Requirements: R2 | Success: `cargo test` passes with new cases; coverage includes all error branches._\r\n\r\n- [ ] 8. Update frontend unit tests for hooks and components\r\n  - File(s): src/__tests__/TaskPlanningPanel.test.tsx (if referencing AI), create new tests under src/__tests__/useTaskForm.test.tsx, src/__tests__/TaskAiParsePanel.test.tsx\r\n  - Purpose: Validate hook state transitions, UI simplified flow, and error messaging with new codes.\r\n  - _Leverage: existing testing-library setup, mock invoke helpers_\r\n  - _Requirements: Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Testing Engineer | Task: Add/adjust unit tests ensuring useTaskForm and TaskAiParsePanel handle success, missing key, timeout, and retry; update snapshots removing CoT elements. | Restrictions: Use testing-library patterns; avoid brittle DOM selectors; ensure tests run in CI. | _Leverage: vitest config, existing mocks_ | _Requirements: R3 | Success: Vitest suite passes with coverage for new flows; snapshots updated accordingly._\r\n\r\n- [ ] 9. Refresh Playwright E2E scenario for AI parse flow\r\n  - File(s): e2e/ai.e2e.ts\r\n  - Purpose: Replace stubbed DOM harness with real app interaction, covering configured key success, missing key error with Settings link, and retry on timeout (mocked via service worker or intercept).\r\n  - _Leverage: existing Playwright config, helpers_\r\n  - _Requirements: Requirement 3_\r\n  - _Prompt: Implement the task for spec ai-integration-simplification, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Automation Engineer | Task: Rewrite ai.e2e.ts to interact with actual UI, mocking DeepSeek responses where needed, verifying single-button flow and error handling. | Restrictions: Keep test deterministic; avoid external network calls; ensure teardown resets mocked state. | _Leverage: Playwright fixtures, mock server utilities_ | _Requirements: R3 | Success: Playwright run passes validating new UX, no legacy elements asserted._\r\n",
  "fileStats": {
    "size": 10729,
    "lines": 65,
    "lastModified": "2025-10-15T15:42:41.308Z"
  },
  "comments": []
}