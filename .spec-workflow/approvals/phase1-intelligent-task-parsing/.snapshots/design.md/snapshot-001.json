{
  "id": "snapshot_1760005289049_crsxjyvle",
  "approvalId": "approval_1760005289025_mco154t9p",
  "approvalTitle": "Phase1 intelligent task parsing design",
  "version": 1,
  "timestamp": "2025-10-09T10:21:29.049Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nPhase 1 为 CogniCal 引入“智能任务解析 + CoT 推理引擎”，在 Phase 0 的基础任务管理框架上补足自然语言解析、AI 增强字段、推理可视化与缓存回退能力。本设计将扩展前端任务创建体验、后端 Tauri 命令层与服务层，并更新本地 SQLite Schema，以确保在离线优先、隐私优先的架构中安全复用 DeepSeek API。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- **前端技术栈**：延续 React + TypeScript + Tailwind + shadcn/ui，复用现有表单、对话框与 Zustand store，新增组件遵循可组合、类型安全原则。\r\n- **后端架构**：在 Tauri 2 + Rust 服务层中实现 DeepSeek 客户端、CoT 引擎与缓存服务，遵循命令 → 服务 → 数据访问的分层结构。\r\n- **AI 集成约束**：采用 reqwest 访问 DeepSeek API，封装 Prompt 模板，保留思维链数据以便可视化；控制网络超时、重试与 Token 消耗。\r\n\r\n### Project Structure (structure.md)\r\n- **Rust 目录**：在 `src-tauri/src/services/` 下新增 `ai_service.rs`、`cot_engine.rs`、`cache_service.rs`，并在 `commands/ai.rs` 中暴露解析命令；扩展 `db/models/task.rs` 与 `db/migrations.rs`。\r\n- **前端目录**：在 `src/components/tasks/` 下新增 `TaskAiParsePanel.tsx`、`TaskCotViewer.tsx`，复用 `TaskFormDialog.tsx`；在 `hooks/useTaskForm.ts` 中串联 AI 解析；在 `services/tauriApi.ts` 与 `types/task.ts` 中扩展数据结构。\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **`TaskFormDialog` / `TaskForm`**：扩展现有表单以支持 AI 解析按钮、结果回填与状态提示。\r\n- **`useTaskForm` Hook**：新增调用 AI 解析逻辑、字段映射与错误提示。\r\n- **`taskStore` (Zustand)**：复用加载态、错误态管理，将 AI 字段写入 `Task` 实体并保留历史行为。\r\n- **`tauriApi` 服务**：在现有命令封装中增加 `parseTask` 方法，同时共享错误映射与离线 mock 机制。\r\n- **`commands/task.rs` 与 `TaskService`**：复用任务持久化接口，为 AI 解析后的字段写入提供合规入口。\r\n\r\n### Integration Points\r\n- **Tauri Commands**：新增 `tasks_parse_ai` 命令；`tasks_create` / `tasks_update` 在持久化前会接受 AI 增强字段。\r\n- **SQLite 数据库**：更新 `tasks` 表以持久化 `planned_start_time`、`estimated_hours`、`task_type`、`tags`、`complexity_score`、`ai_suggested_start_time`、`focus_mode`, `efficiency_prediction` 等字段；建立 `ai_parse_cache` 表保存最近推理结果。\r\n- **缓存与日志**：在 `utils/logger.rs` 中新增日志目标 `app::ai`，使 Phase 2 可读取缓存命中率、延迟指标。\r\n\r\n## Architecture\r\n\r\n整体架构分为前端交互、Tauri 命令层、服务层与数据层：\r\n\r\n```mermaid\r\ngraph TD\r\n  UI[TaskFormDialog\r\n+TaskAiParsePanel\r\n+TaskCotViewer] -->|invoke| TC[Tauri Command\r\n(tasks_parse_ai)]\r\n  TC -->|call| AS[AiService]\r\n  AS -->|prompt| CE[CotEngine]\r\n  AS -->|cache lookup| CS[CacheService]\r\n  AS -->|persist| DB[(SQLite tasks\r\n+ ai_parse_cache)]\r\n  AS -->|log| LOG[Tracing Logger]\r\n  TC -->|result DTO| UI\r\n```\r\n\r\n- **前端**：表单触发 AI 解析，展示加载、成功、失败与缓存命中状态；CoT Viewer 展示思维链步骤。\r\n- **命令层**：纯粹进行输入验证、错误映射与异步任务调度。\r\n- **服务层**：\r\n  - `AiService`：封装 DeepSeek 调用、CoT 引擎、缓存策略，提供结构化结果。\r\n  - `CotEngine`：拼装 Prompt、解析思维链、生成增强字段。\r\n  - `CacheService`：按语义指纹缓存结果，提供 TTL（7 天）与相似度检查。\r\n- **数据层**：`DbPool` 执行迁移、更新任务字段、读写缓存表。\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**：AI 解析 UI、推理展示、缓存提示分别独立组件；Rust 服务各自处理 API 调用、推理解析、缓存管理。\r\n- **Component Isolation**：`TaskAiParsePanel` 只处理请求与展示，不直接修改表单状态；状态更新由 `useTaskForm` 协调。\r\n- **Service Layer Separation**：命令层无业务逻辑，业务集中在 `AiService`；数据库操作集中在 `repositories`。\r\n- **Utility Modularity**：将 Prompt 模板与语义指纹算法放在 `src-tauri/src/utils/ai_prompt.rs`、`semantic.rs` 等独立文件。\r\n\r\n## Components and Interfaces\r\n\r\n### 前端组件\r\n\r\n#### `TaskAiParsePanel`\r\n- **Purpose**：提供自然语言输入、触发 AI 解析、展示状态与结果摘要。\r\n- **Interfaces**：\r\n  - `onApply(result: ParsedTaskPayload)` 回调写回表单。\r\n  - `onFeedback(feedback: { helpful: boolean; message?: string })` 记录用户反馈。\r\n- **Dependencies**：`useTaskForm`、`parseTask` API、`Button`、`Textarea`。\r\n- **Reuses**：`ToastProvider` 反馈状态。\r\n\r\n#### `TaskCotViewer`\r\n- **Purpose**：展示链式推理步骤与最终结论，支持复制。\r\n- **Interfaces**：`steps: CotStep[]`、`summary: string`。\r\n- **Dependencies**：`Dialog`、`ScrollArea`、`Button`。\r\n- **Reuses**：`cn` 工具、`Tooltip`。\r\n\r\n#### `useTaskForm` 更新\r\n- **Purpose**：新增 `triggerAiParse`、`applyAiResult` 方法；管理解析状态、错误、缓存标记。\r\n- **Interfaces**：\r\n  - `aiState: { status: 'idle'|'loading'|'success'|'error'; source: 'live'|'cache' }`\r\n  - `triggerAiParse(input: string): Promise<void>`\r\n- **Dependencies**：`tauriApi.parseTask`、`form` 实例。\r\n- **Reuses**：原有表单验证。\r\n\r\n### Tauri 命令 & 服务\r\n\r\n#### `tasks_parse_ai` 命令\r\n- **Purpose**：处理前端解析请求，返回结构化字段与思维链。\r\n- **Interfaces**：`payload: { input: String, context?: TaskContext }`，返回 `ParsedTaskResponse`。\r\n- **Dependencies**：`AiService`、`AppState`。\r\n- **Reuses**：`CommandResult`、`CommandError`。\r\n\r\n#### `AiService`\r\n- **Purpose**：协调 DeepSeek API 调用、CoT 解析、缓存读写。\r\n- **Interfaces**：`parse_task(input: &AiParseInput) -> Result<AiParseOutput, AppError>`。\r\n- **Dependencies**：`CotEngine`、`CacheService`、`TaskRepository`（用于字段默认值）。\r\n- **Reuses**：`DbPool`、`AppError`。\r\n\r\n#### `CotEngine`\r\n- **Purpose**：生成 Prompt、解析思维链、计算复杂度与建议时间。\r\n- **Interfaces**：`run(&TaskContext, &str) -> Result<CotResult, CotError>`。\r\n- **Dependencies**：`serde_json`、`chrono`、`utils::datetime`。\r\n\r\n#### `CacheService`\r\n- **Purpose**：维护相似度索引、TTL、缓存命中率日志。\r\n- **Interfaces**：\r\n  - `get(&SemanticKey) -> Option<AiParseOutput>`\r\n  - `put(entry: CacheEntry)`\r\n- **Dependencies**：`DbPool`、`semantic_hash` 工具。\r\n\r\n## Data Models\r\n\r\n### TypeScript 扩展\r\n```\r\ninterface Task {\r\n  ...existing fields\r\n  plannedStartAt?: string;\r\n  estimatedMinutes?: number;\r\n  taskType?: 'work' | 'study' | 'life' | 'other';\r\n  tags: string[];\r\n  ai?: {\r\n    complexityScore?: number;\r\n    suggestedStartAt?: string;\r\n    focusMode?: { pomodoros: number; recommendedSlots: string[] };\r\n    efficiencyPrediction?: {\r\n      expectedHours: number;\r\n      confidence: number;\r\n    };\r\n    cotSteps?: CotStep[];\r\n    source: 'live' | 'cache';\r\n    generatedAt: string;\r\n  };\r\n}\r\n\r\ninterface ParsedTaskResponse {\r\n  payload: Partial<TaskPayload>;\r\n  ai: Required<Task['ai']>;\r\n  missingFields: Array<keyof TaskPayload>;\r\n}\r\n```\r\n\r\n### Rust 数据结构\r\n```\r\npub struct AiParseInput {\r\n    pub raw_input: String,\r\n    pub timezone: String,\r\n    pub user_preferences: Option<UserPreferences>,\r\n}\r\n\r\npub struct AiParseOutput {\r\n    pub title: String,\r\n    pub description: String,\r\n    pub priority: String,\r\n    pub planned_start_time: Option<DateTime<Utc>>,\r\n    pub due_at: Option<DateTime<Utc>>,\r\n    pub estimated_hours: Option<f32>,\r\n    pub task_type: Option<String>,\r\n    pub tags: Vec<String>,\r\n    pub complexity_score: i32,\r\n    pub ai_suggested_start_time: Option<DateTime<Utc>>,\r\n    pub focus_mode: Option<FocusModeRecommendation>,\r\n    pub efficiency_prediction: Option<EfficiencyPrediction>,\r\n    pub cot_steps: Vec<CotStep>,\r\n    pub cot_summary: String,\r\n    pub source: AiSource,\r\n}\r\n```\r\n\r\n### 数据库 Schema 更新\r\n```\r\nALTER TABLE tasks ADD COLUMN planned_start_time TEXT;\r\nALTER TABLE tasks ADD COLUMN estimated_hours REAL;\r\nALTER TABLE tasks ADD COLUMN task_type TEXT;\r\nALTER TABLE tasks ADD COLUMN tags TEXT; -- JSON array\r\nALTER TABLE tasks ADD COLUMN complexity_score INTEGER;\r\nALTER TABLE tasks ADD COLUMN ai_suggested_start_time TEXT;\r\nALTER TABLE tasks ADD COLUMN focus_mode TEXT; -- JSON\r\nALTER TABLE tasks ADD COLUMN efficiency_prediction TEXT; -- JSON\r\n\r\nCREATE TABLE ai_parse_cache (\r\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n  semantic_hash TEXT NOT NULL UNIQUE,\r\n  raw_input TEXT NOT NULL,\r\n  output_json TEXT NOT NULL,\r\n  created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  expires_at TEXT NOT NULL,\r\n  usage_count INTEGER NOT NULL DEFAULT 0\r\n);\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1. **DeepSeek API 失败（网络/配额）**\r\n   - **Handling**：捕获后落回缓存（若可用）或返回 `AppError::Other(\"AI 解析失败\")`；前端展示错误并允许手动填写。\r\n   - **User Impact**：提示“AI 服务暂不可用，可稍后重试或改用手动输入”。\r\n\r\n2. **缓存解析数据过期或损坏**\r\n   - **Handling**：`CacheService` 校验 `expires_at` 与 JSON 解析，损坏时自动删除并记录日志；命中失败后回退至实时解析。\r\n   - **User Impact**：无感知；若实时解析也失败，则同 Error1。\r\n\r\n3. **数据库迁移失败**\r\n   - **Handling**：迁移在应用启动时执行，失败记录在日志并阻止应用继续启动，提示用户检查文件系统权限。\r\n   - **User Impact**：无法启动应用，提供错误弹窗与日志路径。\r\n\r\n4. **前端字段回填冲突**（用户已手动填写与 AI 结果冲突）\r\n   - **Handling**：`useTaskForm` 在回填前比对差异，使用对话框提示“是否覆盖”；支持逐项应用。\r\n   - **User Impact**：明确选择覆盖或保留原值。\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- **前端**：\r\n  - `useTaskForm` 针对 `triggerAiParse`、`applyAiResult` 的状态转换、错误处理。\r\n  - `TaskAiParsePanel` 渲染状态（loading/success/error）、按钮禁用逻辑。\r\n- **后端**：\r\n  - `CotEngine` 对 Prompt 解析、复杂度评分、时间计算的纯函数测试。\r\n  - `CacheService` 对命中、TTL、损坏数据清理的逻辑测试。\r\n\r\n### Integration Testing\r\n- **Tauri 命令**：\r\n  - `tasks_parse_ai` 通过 mock DeepSeek HTTP server 验证正向流程、离线回退、缓存命中。\r\n  - 任务 CRUD 搭配新增字段的序列化、反序列化与数据库写入。\r\n- **前端-后端链路**：\r\n  - 使用 `vitest` + `@tauri-apps/api/mocks` 模拟命令返回，确保表单与列表正确展示 AI 字段。\r\n\r\n### End-to-End Testing\r\n- **Playwright 场景**：\r\n  1. 用户输入自然语言 → AI 解析成功 → 字段回填 → 保存任务 → 列表中展示复杂度与 AI 提示。\r\n  2. AI 解析失败 → 显示错误 → 用户手动补全 → 保存任务。\r\n  3. 缓存命中 → 显示“来自缓存”标记 → 用户查看 CoT 步骤。\r\n- **桌面打包测试**：在 Windows/macOS 下验证离线模式回退、API Key 管理、任务导出包含新字段。\r\n",
  "fileStats": {
    "size": 11437,
    "lines": 239,
    "lastModified": "2025-10-09T10:21:15.487Z"
  },
  "comments": []
}